<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- 1. PWA èˆ‡è¢å¹•é–å®šæ ¸å¿ƒè¨­å®š -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- 2. iOS å°ˆç”¨ WebApp æ¨¡å¼æ¨™ç±¤ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FashionFit">
    
    <title>FashionFit AI - æ—¥æœ¬ POP é›œèªŒè©¦è¡£é–“</title>
    
    <!-- 3. è‡ªå®šç¾© App åœ–ç¤º (æŒ‡å‘ public è³‡æ–™å¤¾) -->
    <link rel="icon" href="./public/app-icon.png">
    <link rel="apple-touch-icon" href="./public/app-icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Potta+One&family=Bungee&display=swap');
        
        /* 4. å¼·åˆ¶æ»¿ç‰ˆä¸”ä¸å¯å·¦å³æ»‘å‹• */
        html, body {
            overflow-x: hidden;
            width: 100%;
            height: 100%;
            position: fixed; /* é˜²æ­¢æ©¡çš®ç­‹å›å½ˆæ•ˆæœ */
            background-color: #fffcf0;
        }

        #root {
            height: 100%;
            overflow-y: auto; /* åªå…è¨±å‚ç›´æ²å‹• */
            -webkit-overflow-scrolling: touch;
            /* é‡å° iPhone å®‰å…¨å€åŸŸé€²è¡Œå¡«å…… */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        body { 
            font-family: 'Zen Maru Gothic', sans-serif;
            transition: background-color 0.5s ease;
            touch-action: pan-y; /* é–å®šåªèƒ½ä¸Šä¸‹ç§»å‹• */
        }

        .pop-font {
            font-family: 'Potta One', cursive;
            word-break: break-all; /* é˜²æ­¢é•·æ–‡å­—æº¢å‡º */
        }

        .pop-title {
            font-family: 'Bungee', cursive;
            -webkit-text-stroke: 1.5px black;
            paint-order: stroke fill;
        }

        .btn-3d {
            transition: all 0.1s;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
            border: 2px solid black;
        }
        .btn-3d:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px 0px rgba(0,0,0,1);
        }

        .clay-box {
            border: 3px solid black;
            box-shadow: 6px 6px 0px 0px rgba(0,0,0,1);
            border-radius: 24px;
            transition: all 0.3s ease;
            max-width: 100%; /* ç¢ºä¿æ¡†æ¡†ä¸è¶…å‡ºçˆ¶å…ƒç´  */
        }

        .bg-pattern-day {
            background-color: #fffcf0;
            background-image: radial-gradient(#ffcad4 1.5px, transparent 1.5px);
            background-size: 20px 20px;
        }
        .bg-pattern-night {
            background-color: #0f172a;
            background-image: radial-gradient(#44337a 1.5px, transparent 1.5px);
            background-size: 20px 20px;
        }

        .vertical-text {
            writing-mode: vertical-rl;
        }

        /* å°ˆé–€é‡å°æ‰‹æ©Ÿå¯¬åº¦çš„å„ªåŒ– */
        @media (max-width: 640px) {
            .pop-title {
                font-size: 3.5rem !important;
                line-height: 1;
            }
            .clay-box {
                box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
            }
        }
    </style>
</head>
<body class="antialiased">
    <div id="root"></div>

    <script type="text/babel">
        // --- è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ API Key ---
        const apiKey = "AIzaSyCU3UDiAg54LLvBO4Qn7rwWjmxUeen7J7c"; 
        // -----------------------------

        const { useState, useEffect } = React;

        const Icons = {
            Sun: () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>
            ),
            Moon: () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
            ),
            Sparkles: () => (
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4M3 5h4M19 17v4M17 19h4"/></svg>
            ),
            Refresh: () => (
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
            ),
            Download: () => (
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
            ),
            Shirt: () => (
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/></svg>
            ),
            Camera: () => (
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="14" x="3" y="8" rx="2" ry="2"/><path d="M7 5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v3H7V5z"/><circle cx="12" cy="15" r="3"/></svg>
            ),
            Star: ({ fill }) => (
                <svg width="40" height="40" viewBox="0 0 24 24" fill={fill} stroke="black" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            ),
            Heart: ({ fill }) => (
                <svg width="40" height="40" viewBox="0 0 24 24" fill={fill} stroke="black" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
            )
        };

        const App = () => {
            const [isDark, setIsDark] = useState(false);
            const [personImage, setPersonImage] = useState(null);
            const [itemImage, setItemImage] = useState(null);
            const [fitStyle, setFitStyle] = useState("natural");
            const [isGenerating, setIsGenerating] = useState(false);
            const [resultImage, setResultImage] = useState(null);
            const [statusMsg, setStatusMsg] = useState("");

            const fileToBase64 = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                });
            };

            const callGemini = async (personB64, itemB64, prompt) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/png", data: personB64 } },
                            { inlineData: { mimeType: "image/png", data: itemB64 } }
                        ]
                    }],
                    generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
                };
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error("API Error");
                const result = await response.json();
                return result.candidates[0].content.parts.find(p => p.inlineData).inlineData.data;
            };

            const handleTryOn = async () => {
                if (!personImage || !itemImage) {
                    setStatusMsg("âš ï¸ å“å‘€ï¼è¨˜å¾—å…ˆé¸å¥½ç…§ç‰‡å–”ï¼");
                    return;
                }
                if (!apiKey) {
                    setStatusMsg("âš ï¸ å°šæœªè¨­å®š API Keyï¼Œè«‹å…ˆæ–¼ç¨‹å¼ç¢¼æœ€ä¸Šæ–¹å¡«å…¥ï¼");
                    return;
                }
                setIsGenerating(true);
                setStatusMsg("âœ¨ é­”æ³•æ­£åœ¨ç™¼ç”Ÿä¸­...");
                try {
                    const pB64 = await fileToBase64(personImage);
                    const iB64 = await fileToBase64(itemImage);
                    const fitDesc = fitStyle === "tight" ? "extremely tight fit, showing fabric tension" : "cute natural fit";
                    const prompt = `Japanese POP Magazine style. Virtual try-on: replace clothes on person in image 1 with clothing from image 2. Fit: ${fitDesc}. Vivid trendy colors. Maintain identity.`;
                    
                    const base64 = await callGemini(pB64, iB64, prompt);
                    setResultImage(`data:image/png;base64,${base64}`);
                    setStatusMsg("ğŸ‰ å®Œæˆï¼ä½ çœ‹èµ·ä¾†è¶…æ£’çš„ï¼");
                } catch (e) { 
                    setStatusMsg("âŒ é­”æ³•å¤±æ•—äº†ï¼Œå†è©¦ä¸€æ¬¡å§ï¼");
                } finally { 
                    setIsGenerating(false); 
                }
            };

            return (
                <div className={`min-h-full transition-all duration-500 ${isDark ? 'bg-pattern-night text-white' : 'bg-pattern-day text-black'} p-4 md:p-8`}>
                    <div className="max-w-screen-sm mx-auto">
                        
                        <header className="flex flex-row items-center justify-between mb-8 gap-4 pt-2">
                            <div className="relative">
                                <h1 className={`text-5xl pop-title italic tracking-tighter ${isDark ? 'text-cyan-400' : 'text-pink-400'}`}>
                                    POP<span className={isDark ? 'text-purple-400' : 'text-yellow-400'}>Fit!</span>
                                </h1>
                            </div>

                            <button 
                                onClick={() => setIsDark(!isDark)}
                                className={`flex items-center gap-2 px-4 py-2 clay-box btn-3d rounded-full transition-all ${isDark ? 'bg-purple-900 text-cyan-300 border-cyan-400' : 'bg-white text-pink-500 border-black'}`}
                            >
                                {isDark ? <Icons.Moon /> : <Icons.Sun />}
                                <span className="font-black text-sm tracking-widest">{isDark ? 'NIGHT' : 'DAY'}</span>
                            </button>
                        </header>

                        <main className="space-y-10">
                            <div className="space-y-10">
                                {/* STEP 1 */}
                                <div className="relative">
                                    <div className={`absolute -top-4 -left-2 z-10 px-4 py-1 clay-box text-xs font-black rotate-[-3deg] ${isDark ? 'bg-cyan-500 text-white' : 'bg-pink-400 text-white'}`}>
                                        STEP 01: YOU
                                    </div>
                                    <div className={`upload-card aspect-[4/5] clay-box bg-white overflow-hidden relative group cursor-pointer border-4 ${isDark ? 'border-cyan-400 shadow-none' : 'border-black shadow-none'}`}>
                                        {personImage ? (
                                            <img src={URL.createObjectURL(personImage)} className="w-full h-full object-cover" />
                                        ) : (
                                            <div className="flex flex-col items-center justify-center h-full gap-2">
                                                <div className={`w-16 h-16 rounded-full flex items-center justify-center border-4 border-black ${isDark ? 'bg-slate-800 text-cyan-400' : 'bg-pink-50 text-pink-400'}`}>
                                                    <Icons.Camera />
                                                </div>
                                                <p className="font-black text-gray-400 text-xs tracking-widest uppercase pop-font">ä¸Šå‚³æœ¬äººç…§ç‰‡</p>
                                            </div>
                                        )}
                                        <input type="file" onChange={e => setPersonImage(e.target.files[0])} className="absolute inset-0 opacity-0 cursor-pointer z-20" />
                                    </div>
                                </div>

                                {/* STEP 2 & FIT */}
                                <div className="space-y-6">
                                    <div className="flex gap-2">
                                        {['tight', 'natural', 'oversized'].map(s => (
                                            <button 
                                                key={s} 
                                                onClick={() => setFitStyle(s)}
                                                className={`flex-1 py-3 clay-box btn-3d font-black text-[10px] tracking-tighter transition-all ${
                                                    fitStyle === s 
                                                    ? (isDark ? 'bg-cyan-400 text-black shadow-none translate-x-1 translate-y-1' : 'bg-yellow-400 text-black shadow-none translate-x-1 translate-y-1') 
                                                    : (isDark ? 'bg-slate-800 text-slate-500 border-slate-700' : 'bg-white text-gray-400 border-black shadow-none')
                                                }`}
                                            >
                                                {s === 'tight' ? 'ç·Šèº«â™¥' : s === 'natural' ? 'åˆèº«â˜…' : 'å¯¬é¬†â™ª'}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="relative">
                                        <div className={`absolute -top-4 -right-2 z-10 px-4 py-1 clay-box text-xs font-black rotate-[3deg] ${isDark ? 'bg-purple-500 text-white' : 'bg-yellow-400 text-black'}`}>
                                            STEP 02: OUTFIT
                                        </div>
                                        <div className={`upload-card aspect-square clay-box bg-white overflow-hidden relative group border-4 ${isDark ? 'border-purple-400 shadow-none' : 'border-black shadow-none'}`}>
                                            {itemImage ? (
                                                <img src={URL.createObjectURL(itemImage)} className="w-full h-full object-cover" />
                                            ) : (
                                                <div className="flex flex-col items-center justify-center h-full gap-2">
                                                    <div className={`w-16 h-16 rounded-full flex items-center justify-center border-4 border-black ${isDark ? 'bg-slate-800 text-purple-400' : 'bg-yellow-50 text-yellow-500'}`}>
                                                        <Icons.Shirt />
                                                    </div>
                                                    <p className="font-black text-gray-400 text-xs tracking-widest uppercase pop-font">ä¸Šå‚³è¡£ç‰©åœ–ç‰‡</p>
                                                </div>
                                            )}
                                            <input type="file" onChange={e => setItemImage(e.target.files[0])} className="absolute inset-0 opacity-0 cursor-pointer z-20" />
                                        </div>
                                    </div>
                                </div>

                                <button 
                                    onClick={handleTryOn}
                                    disabled={isGenerating}
                                    className={`w-full py-6 btn-3d rounded-[2rem] border-4 border-black font-black text-2xl tracking-[0.2em] flex items-center justify-center gap-4 transition-all ${
                                        isGenerating 
                                        ? 'bg-gray-200 text-gray-400 shadow-none translate-x-1 translate-y-1' 
                                        : (isDark ? 'bg-gradient-to-r from-cyan-400 to-purple-500 text-black' : 'bg-gradient-to-r from-pink-400 to-yellow-400 text-white')
                                    }`}
                                >
                                    {isGenerating ? <div className="animate-spin"><Icons.Refresh /></div> : <Icons.Sparkles />}
                                    {isGenerating ? 'MAGIC...' : 'GO! è©¦ç©¿çœ‹'}
                                </button>
                                {statusMsg && <p className="text-center font-black italic text-md pop-font">{statusMsg}</p>}
                            </div>

                            <div className="pt-4">
                                <div className={`relative clay-box p-6 min-h-[400px] flex flex-col items-center justify-center border-4 ${isDark ? 'bg-slate-900 border-cyan-400 shadow-none' : 'bg-white border-black shadow-none'}`}>
                                    <div className="absolute top-4 left-4 -rotate-12">
                                        <Icons.Star fill={isDark ? '#22d3ee' : '#facc15'} />
                                    </div>
                                    <div className="absolute bottom-10 right-4 rotate-12">
                                        <Icons.Heart fill={isDark ? '#e879f9' : '#f472b6'} />
                                    </div>

                                    {resultImage ? (
                                        <div className="w-full space-y-8 animate-in zoom-in duration-500">
                                            <div className="relative group p-1 bg-black rounded-[2rem]">
                                                <img src={resultImage} className="w-full rounded-[1.8rem] border-2 border-white" />
                                                <div className="absolute top-6 right-6 z-20 vertical-text font-black text-white bg-black px-2 py-4 text-[10px] tracking-widest border border-white">
                                                    SNAP NO. 2025
                                                </div>
                                            </div>
                                            <button 
                                                onClick={() => {
                                                    const link = document.createElement('a');
                                                    link.href = resultImage;
                                                    link.download = 'pop-look.png';
                                                    link.click();
                                                }}
                                                className={`w-full py-4 clay-box btn-3d font-black flex items-center justify-center gap-2 text-md ${isDark ? 'bg-cyan-400 text-black border-black' : 'bg-pink-400 text-white border-black'}`}
                                            >
                                                <Icons.Download /> ä¸‹è¼‰é€™å¥— LOOK
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="text-center space-y-6 py-10">
                                            <div className={`w-24 h-24 mx-auto rounded-full flex items-center justify-center border-4 border-dashed ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-pink-50 border-gray-200'}`}>
                                                <div className="animate-pulse opacity-20"><Icons.Sparkles /></div>
                                            </div>
                                            <div className="space-y-2">
                                                <p className={`text-xl font-black pop-font ${isDark ? 'text-slate-700' : 'text-gray-200'}`}>ç­‰å¾…å¥‡è¹Ÿç™¼ç”Ÿ...</p>
                                                <p className="text-[10px] font-black tracking-widest text-gray-400 italic uppercase">Fashion Star</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                <div className={`mt-6 flex justify-between items-center px-4 py-2 rounded-full border-2 border-black ${isDark ? 'bg-slate-800' : 'bg-white'}`}>
                                    <span className="font-black text-[8px] tracking-[0.2em] uppercase italic opacity-60">PopFit Ed.</span>
                                    <div className="flex gap-2">
                                        {[1, 2, 3].map(i => <div key={i} className={`w-2 h-2 rounded-full border border-black ${i === 1 ? 'bg-pink-400' : i === 2 ? 'bg-yellow-400' : 'bg-cyan-400'}`}></div>)}
                                    </div>
                                    <span className="font-black text-[8px] italic opacity-60">#OOTD #AI</span>
                                </div>
                            </div>
                        </main>

                        <footer className="mt-12 py-8 text-center border-t-4 border-black border-dashed opacity-30">
                            <p className="font-black text-xs tracking-[0.4em]">FASHIONFIT 2025</p>
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
